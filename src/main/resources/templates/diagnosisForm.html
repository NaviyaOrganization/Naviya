<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아이 성향 진단하기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="/assets/css/newSidebar.css" rel="stylesheet">
    <style>
        body {
            background-color: #fff9e6;
            font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
            overflow-x: hidden;
        }
        .main-container {
            min-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quiz-container {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            width: 100%;
            max-width: 768px;
        }
        .quiz-header {
            background-color: #ffe066;
            color: #5a4d41;
            padding: 1.5rem;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        .quiz-content {
            padding: 2rem;
        }
        .question-container {
            display: none;
        }
        .question-container.active {
            display: block;
        }
        .btn-answer {
            display: block;
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: left;
            font-size: 1.1rem;
            background-color: #fff3b0;
            color: #5a4d41;
            border: none;
            border-radius: 15px;
            transition: all 0.3s ease;
        }
        .btn-answer:hover {
            background-color: #ffe066;
            transform: scale(1.02);
        }
        .btn-answer.selected {
            background-color: #ffd43b;
            box-shadow: 0 0 0 3px #ffe066;
        }
        .btn-nav {
            min-width: 100px;
            background-color: #ffe066;
            color: #5a4d41;
            border: none;
            border-radius: 20px;
            padding: 10px 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-nav:hover {
            background-color: #ffd43b;
            transform: scale(1.05);
        }
        .progress-container {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .progress {
            height: 0.5rem;
            background-color: #fff3b0;
            border-radius: 0.25rem;
            flex-grow: 1;
            margin-right: 1rem;
        }
        .progress-bar {
            background-color: #ffe066;
        }
        .progress-text {
            font-size: 1.2rem;
            font-weight: bold;
            color: #5a4d41;
        }
        h1 {
            color: #5a4d41;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 0 #fff9e6;
            font-size: 2.5rem;
            letter-spacing: 2px;
        }
        h2 {
            color: #5a4d41;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
        }
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }
        .completion-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
        <span id="toggleSidebar" class="navbar-toggler-icon"></span>
        <div class="collapse navbar-collapse justify-content-end">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/"><i class="fas fa-home"></i> 메인페이지</a>
                </li>
                <li class="nav-item" th:if="${user == null}">
                    <a class="nav-link" href="/login"><i class="fas fa-sign-in-alt"></i> 로그인</a>
                </li>
                <li class="nav-item" th:if="${user == null}">
                    <a class="nav-link" href="/signup"><i class="fas fa-user-plus"></i> 회원가입</a>
                </li>
                <li class="nav-item" th:if="${user != null}">
                    <a class="nav-link" th:text="${user.name + '님'}"><i class="fas fa-user-plus"></i></a>
                </li>
                <li class="nav-item" th:if="${user != null}">
                    <a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> 로그아웃</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Sidebar with Icons -->
<div id="sidebar">
    <a href="/children/select"><i class="fas fa-child"></i> 아이 프로필 변경</a>
    <a href="/children/page"><i class="fas fa-edit"></i> 아이 정보 수정</a>
    <a href="/userpage"><i class="fas fa-user"></i> 계정보기</a>
    <a href="/children/childMBTIResult"><i class="fas fa-user-circle"></i> 아이 성향 확인하기</a>
    <a href="#"><i class="fas fa-history"></i> 최근 책 보기</a>
    <a href="/ChildFavorBookList.html"><i class="fas fa-heart"></i> 좋아요 누른 책 보기</a>
    <a href="#"><i class="fas fa-tags"></i> 카테고리 별 책보기</a>
    <a href="/lottery/form"><i class="fas fa-gift"></i> 선착순 이벤트</a>
</div>

<script src="/assets/js/newSidebar.js"></script>

<div class="alert alert-warning" role="alert" id="warningAlert">
    모든 질문에 답변해주세요!
</div>
<div class="main-container">
    <div class="quiz-container">
        <div class="quiz-header">
            <h1 class="h3 mb-0">아이 성향 진단하기</h1>
        </div>
        <div class="quiz-content">
            <div id="start-screen" class="text-center">
                <h2 class="mb-4">재미있는 질문에 답해볼까요?</h2>
                <button onclick="startQuiz()" class="btn btn-nav btn-lg">시작하기</button>
            </div>

            <div id="quiz-screen" style="display: none;">
                <div class="progress-container">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div id="progress-text" class="progress-text">1 / 4</div>
                </div>

                <div id="questions-container">
                    <!-- 질문이 여기에 동적으로 삽입됩니다 -->
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button onclick="handlePrev()" id="prevButton" class="btn btn-nav" disabled>이전</button>
                    <button onclick="handleNext()" id="nextButton" class="btn btn-nav">다음</button>
                </div>
            </div>

            <div id="end-screen" class="text-center" style="display: none;">
                <h2 class="mb-4">진단이 완료되었어요!</h2>
                <button onclick="checkResults()" class="btn btn-nav btn-lg">결과 확인하기</button>
            </div>
        </div>
    </div>
</div>

<canvas id="confetti-canvas"></canvas>
<div class="completion-message" id="completionMessage">
    <h2>진단이 완료되었습니다!</h2>
    <p>결과를 확인해보세요.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const questions = [
        { text: "친구들과 같이 노는 게 더 재밌나요, 아니면 혼자서 조용히 노는 게 더 좋나요?", answers: [{ text: "친구들이랑 같이 노는 게 좋아요!", value: "E" }, { text: "혼자서 조용히 노는 게 좋아요!", value: "I" }] },
        { text: "이미 알고 있는 놀이를 다시 하는 게 좋나요, 아니면 새로운 놀이를 배우는 게 좋나요?", answers: [{ text: "알고 있는 놀이가 좋아요!", value: "S" }, { text: "새로운 놀이가 좋아요!", value: "N" }] },
        { text: "친구가 슬퍼하면 왜 그런지 궁금한가요, 아니면 바로 친구를 위로해주고 싶나요?", answers: [{ text: "왜 슬픈지 궁금해요!", value: "T" }, { text: "바로 위로해 주고 싶어요!", value: "F" }] },
        { text: "놀이가 끝난 후 물건을 정리하는 게 좋나요, 아니면 그냥 두는 게 좋나요?", answers: [{ text: "물건을 정리하는 게 좋아요!", value: "J" }, { text: "그냥 두는 게 좋아요!", value: "P" }] }
    ];

    let currentQuestion = 0;
    let answers = new Array(questions.length).fill('');

    function startQuiz() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('quiz-screen').style.display = 'block';
        renderQuestions();
        showQuestion(currentQuestion);
    }

    function renderQuestions() {
        const container = document.getElementById('questions-container');
        questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.id = `question-${index}`;
            questionDiv.className = 'question-container';
            questionDiv.innerHTML = `
                <h2 class="mb-4">${question.text}</h2>
                ${question.answers.map((answer, answerIndex) => `
                    <button onclick="handleAnswer('${answer.value}', ${index})"
                            class="btn btn-answer mb-3"
                            id="answer-${index}-${answerIndex}">
                        ${answer.text}
                    </button>
                `).join('')}
            `;
            container.appendChild(questionDiv);
        });
    }

    function showQuestion(index) {
        document.querySelectorAll('.question-container').forEach(el => el.classList.remove('active'));
        document.getElementById(`question-${index}`).classList.add('active');
        updateProgress();
        updateNavButtons();
        updateSelectedAnswer();
    }

    function handleAnswer(value, questionIndex) {
        answers[questionIndex] = value;
        updateSelectedAnswer();
        if (questionIndex < questions.length - 1) {
            currentQuestion++;
            showQuestion(currentQuestion);
        } else {
            updateNavButtons();
        }
    }

    function updateSelectedAnswer() {
        questions[currentQuestion].answers.forEach((answer, index) => {
            const button = document.getElementById(`answer-${currentQuestion}-${index}`);
            button.classList.toggle('selected', answer.value === answers[currentQuestion]);
        });
    }

    function handlePrev() {
        if (currentQuestion > 0) {
            currentQuestion--;
            showQuestion(currentQuestion);
        }
    }

    function handleNext() {
        if (currentQuestion < questions.length - 1) {
            currentQuestion++;
            showQuestion(currentQuestion);
        } else {
            checkCompletion();
        }
    }

    function updateProgress() {
        const progress = ((currentQuestion + 1) / questions.length) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        document.getElementById('progress-bar').setAttribute('aria-valuenow', progress);
        document.getElementById('progress-text').textContent = `${currentQuestion + 1} / ${questions.length}`;
    }

    function updateNavButtons() {
        document.getElementById('prevButton').disabled = currentQuestion === 0;
        document.getElementById('nextButton').textContent = currentQuestion === questions.length - 1 ? '완료' : '다음';
    }

    function checkCompletion() {
        if (answers.every(answer => answer !== '')) {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('end-screen').style.display = 'block';
        } else {
            showWarning();
        }
    }

    function showWarning() {
        const warningAlert = document.getElementById('warningAlert');
        warningAlert.style.display = 'block';
        setTimeout(() => {
            warningAlert.style.display = 'none';
        }, 3000);
    }

    function checkResults() {
        const resultButton = document.querySelector('#end-screen button');
        resultButton.disabled = true; // 버튼 비활성화

        fetch(`/api/mbti/diagnose`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                eiScore: answers[0],
                snScore: answers[1],
                tfScore: answers[2],
                jpScore: answers[3]
            })
        })
            .then(response => {
                if (!response.ok) throw new Error('MBTI 진단 요청 실패');
                return response.json();
            })
            .then(data => {
                console.log("진단 결과:", data);
                showCompletionMessage();
                startConfetti();
                setTimeout(() => {
                    window.location.href = "http://localhost:8080/children/childMBTIResult";
                }, 3000);
            })
            .catch(error => {
                console.error("오류 발생:", error);
                alert('진단 결과를 전송하는 데 실패했습니다.');
                resultButton.disabled = false; // 실패 시 버튼을 다시 활성화
            });
    }

    function showCompletionMessage() {
        document.getElementById('completionMessage').style.display = 'block';
    }

    function startConfetti() {
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
    }
    /*]]>*/
</script>
</body>
</html>