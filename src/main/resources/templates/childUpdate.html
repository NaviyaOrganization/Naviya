<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>아이 정보 수정</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link href="/assets/css/newSidebar.css" rel="stylesheet">
  <style>
    .card {
      background-color: #fff;
      border-radius: 25px;
      border: none;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      padding: 2rem;
    }

    .profile-picture {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #fff3b0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      cursor: pointer;
      overflow: hidden;
      border: 3px solid #ffe066;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .profile-picture:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(255, 224, 102, 0.4);
    }

    .profile-picture img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .form-label {
      color: #5a4d41;
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .form-control {
      border: 2px solid #ffe066;
      border-radius: 15px;
      padding: 0.8rem;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: #ffd43b;
      box-shadow: 0 0 0 0.25rem rgba(255, 224, 102, 0.25);
    }

    .gender-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 10px;
    }

    .gender-option {
      position: relative;
      width: 120px;
    }

    .gender-option input[type="radio"] {
      display: none;
    }

    .gender-option label {
      display: block;
      padding: 12px 20px;
      background: #fff;
      border: 2px solid #ffe066;
      border-radius: 15px;
      cursor: pointer;
      text-align: center;
      color: #5a4d41;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .gender-option input[type="radio"]:checked + label {
      background: #ffe066;
      color: #5a4d41;
      transform: scale(1.05);
    }

    .btn {
      padding: 12px 30px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background-color: #ffe066;
      border: none;
      color: #5a4d41;
    }

    .btn-primary:hover {
      background-color: #ffd43b;
      transform: scale(1.05);
      color: #5a4d41;
    }

    .btn-secondary {
      background-color: #f8f9fa;
      border: 2px solid #ffe066;
      color: #5a4d41;
    }

    .btn-secondary:hover {
      background-color: #fff3b0;
      border-color: #ffd43b;
      color: #5a4d41;
      transform: scale(1.05);
    }

    .interest-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      padding: 20px 0;
    }

    .interest-item {
      background: #fff;
      border: 2px solid #ffe066;
      border-radius: 15px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #5a4d41;
      font-weight: 600;
    }

    .interest-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(255, 224, 102, 0.3);
    }

    .interest-item.selected {
      background: #ffe066;
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(255, 224, 102, 0.4);
    }

    .modal-content {
      border-radius: 25px;
      border: none;
    }

    .modal-header {
      background-color: #ffe066;
      border-radius: 25px 25px 0 0;
      color: #5a4d41;
    }

    .modal-body img:hover {
      transform: scale(1.05);
      transition: transform 0.3s ease;
      cursor: pointer;
    }

    .delete-btn {
      background-color: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .delete-btn:hover {
      background-color: #ff5252;
      transform: scale(1.05);
    }
  </style>
</head>
<body>


<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <span id="toggleSidebar" class="navbar-toggler-icon"></span>
    <div class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/"><i class="fas fa-home"></i> 메인페이지</a>
        </li>
        <li class="nav-item" th:if="${user == null}">
          <a class="nav-link" href="/login"><i class="fas fa-sign-in-alt"></i> 로그인</a>
        </li>
        <li class="nav-item" th:if="${user == null}">
          <a class="nav-link" href="/signup"><i class="fas fa-user-plus"></i> 회원가입</a>
        </li>
        <li class="nav-item" th:if="${user != null}">
          <a class="nav-link" th:text="${user.name + '님'}"><i class="fas fa-user-plus"></i></a>
        </li>
        <li class="nav-item" th:if="${user != null}">
          <a class="nav-link" href="/logout"><i class="fas fa-sign-out-alt"></i> 로그아웃</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Sidebar with Icons -->
<div id="sidebar">
  <a href="/children/select"><i class="fas fa-child"></i> 아이 프로필 변경</a>
  <a href="/children/page"><i class="fas fa-edit"></i> 아이 정보 수정</a>
  <a href="/userpage"><i class="fas fa-user"></i> 계정보기</a>
  <a href="#"><i class="fas fa-history"></i> 최근 책 보기</a>
  <a href="/ChildFavorBookList.html"><i class="fas fa-heart"></i> 좋아요 누른 책 보기</a>
  <a href="#"><i class="fas fa-tags"></i> 카테고리 별 책보기</a>
  <a href="/lottery/form"><i class="fas fa-gift"></i> 선착순 이벤트</a>
</div>
<script src="/assets/js/newSidebar.js"></script>




<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <h2 class="text-center mb-4">아이 정보 수정</h2>

      <div class="card">
        <div class="card-body">
          <form id="childForm">
            <div id="basicInfoSection">
              <div class="mb-3 text-center">
                <div class="profile-picture" onclick="openImageSelectionModal()">
                  <img id="profileImage" th:src="@{'/assets/img/' + ${childAddDto.childDto.childImage}}" alt="프로필 사진">
                </div>
                <p class="mt-2">프로필 사진 선택</p>
              </div>
              <div class="mb-3">
                <label for="name" class="form-label">이름</label>
                <input type="text" class="form-control" id="name" th:value="${childAddDto.childDto.childName}" required>
                <input type="hidden" id="childId" th:value="${childAddDto.childDto.childId}">
              </div>
              <div class="mb-3">
                <input type="hidden" id="childGender" th:value="${childAddDto.childDto.childGender}">
                <label class="form-label">성별</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="male" value="M">
                    <label class="form-check-label" for="male">남</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="female" value="F">
                    <label class="form-check-label" for="female">여</label>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="age" class="form-label">나이</label>
                <input type="number" class="form-control" id="age" th:value="${childAddDto.childDto.childAge}" required>
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-primary" onclick="showInterestSection()">다음</button>
              </div>
            </div>
<!--            <div id="interestSection">-->
            <div id="interestSection" style="display: none;">
              <div class="mb-3">
                <label class="form-label">관심사 선택 (최대 3개)</label>
                <div class="interest-grid" id="interestGrid">
                  <!-- 관심사 항목을 JavaScript에서 추가 -->
                </div>
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-secondary me-2" onclick="showBasicInfoSection()">이전</button>
                <button type="button" class="btn btn-primary" onclick="updateChild()">수정하기</button>
              </div>
            </div>
            <input type="hidden" id="selectedProfileId" name="selectedProfileId" value="">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="text-center mt-5">
  <button type="button" class="btn btn-primary delete-btn" onclick="deleteChild()">삭제하기</button>
</div>

<!-- 이미지 선택 모달 -->
<div class="modal fade" id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileImageModalLabel">프로필 이미지 선택</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- 정적으로 9개의 이미지 추가 -->
          <div class="col-4 mb-3">
            <img src="/assets/img/profile1.png" class="img-thumbnail" onclick="selectProfileImage(1)" alt="Profile 1">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile2.png" class="img-thumbnail" onclick="selectProfileImage(2)" alt="Profile 2">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile3.png" class="img-thumbnail" onclick="selectProfileImage(3)" alt="Profile 3">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile4.png" class="img-thumbnail" onclick="selectProfileImage(4)" alt="Profile 4">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile5.png" class="img-thumbnail" onclick="selectProfileImage(5)" alt="Profile 5">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile6.png" class="img-thumbnail" onclick="selectProfileImage(6)" alt="Profile 6">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile7.png" class="img-thumbnail" onclick="selectProfileImage(7)" alt="Profile 7">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile8.png" class="img-thumbnail" onclick="selectProfileImage(8)" alt="Profile 8">
          </div>
          <div class="col-4 mb-3">
            <img src="/assets/img/profile9.png" class="img-thumbnail" onclick="selectProfileImage(9)" alt="Profile 9">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- 해당 성별 값 radio selected -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 숨겨진 input 요소에서 서버로부터 전달된 성별 값을 읽어옵니다.
    const childGender = document.getElementById("childGender").value;

    // 해당 성별 값을 가진 라디오 버튼을 체크합니다.
    if (childGender) {
      const genderRadio = document.querySelector(`input[name="gender"][value="${childGender}"]`);
      if (genderRadio) {
        genderRadio.checked = true;
      }
    }
    // 기본 섹션을 보이도록 설정
    document.getElementById('basicInfoSection').style.display = 'block';
    // 카테고리 섹션은 숨김 상태로 시작
    document.getElementById('interestSection').style.display = 'none';
  });
</script>
<script th:inline="javascript">
  /* 서버에서 전달된 storedInterests 데이터를 JS 배열로 변환 */
  // const storedInterests = /*[[${childAddDto.childFavCategoryDtoList}]]*/ [];
  // console.log(storedInterests);

  // 모달을 열기 위한 함수
  function openImageSelectionModal() {
    const modal = new bootstrap.Modal(document.getElementById('profileImageModal'));
    modal.show();
  }

  // 프로필 이미지 선택 시 이미지 ID를 저장
  function selectProfileImage(profileId) {
    document.getElementById('profileImage').src = `/assets/img/profile${profileId}.png`;
    document.getElementById('selectedProfileId').value = profileId;
    const modal = bootstrap.Modal.getInstance(document.getElementById('profileImageModal'));
    modal.hide();
  }

  // 기본 정보 섹션의 유효성 검사
  function validateBasicInfo() {
    // 기본적으로 true를 반환하여 유효성 검사를 통과시킵니다.
    return true;
  }

  const categories = [
    {code: "010", name: "소설"},
    {code: "020", name: "전래동화"},
    {code: "030", name: "과학"},
    {code: "040", name: "수학"},
    {code: "050", name: "역사"},
    {code: "060", name: "동물"},
    {code: "070", name: "문학"},
    {code: "080", name: "자연"}
  ];

  // 서버에서 전달된 storedInterests 데이터를 JS 배열로 변환
  const storedInterests = /*[[${childAddDto.childFavCategoryDtoList}]]*/ [];

  console.log(storedInterests);

  function loadProfileData() {
    const storedImage = localStorage.getItem('selectedProfileImage');
    if (storedImage) {
      document.getElementById('profileImage').src = storedImage;
    }
    renderInterests();
  }

  function renderInterests() {
    const interestGrid = document.getElementById('interestGrid');
    interestGrid.innerHTML = '';

    categories.forEach(category => {
      const interestItem = document.createElement('div');
      interestItem.className = 'interest-item';
      interestItem.textContent = category.name;
      interestItem.dataset.code = category.code;
      interestItem.onclick = () => toggleInterest(interestItem);

      if (storedInterests.some(favCategory => favCategory.categoryCode === category.code)) {
        interestItem.classList.add('selected');
      }

      interestGrid.appendChild(interestItem);
    });
  }

  function toggleInterest(element) {
    const selectedInterests = document.querySelectorAll('.interest-item.selected');
    if (!element.classList.contains('selected') && selectedInterests.length >= 3) {
      alert('최대 3개까지만 선택할 수 있습니다.');
      return;
    }
    element.classList.toggle('selected');
  }

  window.addEventListener('load', loadProfileData);

  function showInterestSection() {
    if (validateBasicInfo()) {
      document.getElementById('basicInfoSection').style.display = 'none';
      document.getElementById('interestSection').style.display = 'block';
    }
  }

  function showBasicInfoSection() {
    document.getElementById('basicInfoSection').style.display = 'block';
    document.getElementById('interestSection').style.display = 'none';
  }

  function updateChild() {
    // 필수 필드 검증
    const name = document.getElementById('name').value;
    console.log(name);

    if (!name) {
      alert('이름을 입력해주세요.');
      return;
    }

    const gender = document.querySelector('input[name="gender"]:checked')?.value;
    console.log('Selected gender:', gender);

    if (!gender) {
      alert('성별을 선택해주세요.');
      return;
    }

    const age = parseInt(document.getElementById('age').value);
    console.log(age);

    if (!age || age < 1) {
      alert('올바른 나이를 입력해주세요.');
      return;
    }

    // 관심사 검증
    const interests = Array.from(document.querySelectorAll('.interest-item.selected'))
            .map(el => el.dataset.code);
    console.log(interests);

    if (interests.length === 0) {
      alert('최소 하나의 관심사를 선택해주세요.');
      return;
    }

    // 프로필 이미지 처리
    let selectedProfileId = document.getElementById('selectedProfileId').value;
    if (!selectedProfileId) {
      // 기존 이미지 URL에서 프로필 번호 추출
      const currentImageSrc = document.getElementById('profileImage').src;
      const profileMatch = currentImageSrc.match(/profile(\d+)\.png/);
      if (profileMatch) {
        selectedProfileId = profileMatch[1];
      }
    }

    const childId = document.getElementById('childId').value;

    // API 요청 데이터 구성
    const requestData = {
      childDto: {
        childId: childId,
        childName: name,
        childAge: age,
        childGender: gender,
        childImage: 'profile'+selectedProfileId+".png" ,
        codeMbti: ""
      },
      categoryCodeList: interests
    };

    console.log(requestData);
    console.log('Sending request with data:', requestData);

    // API 호출
    axios.put('/children/detailPage/update', requestData)
            .then(response => {
              console.log('Success response:', response);
              alert('아이 정보가 성공적으로 수정되었습니다.');
              window.location.href = '/children/page';
            })
            .catch(error => {
              console.error('Error details:', error.response || error);
              alert('아이 정보 수정에 실패했습니다. 다시 시도해주세요.');
            });
  }

  // 자녀 삭제 요청을 처리하는 함수 추가
  function deleteChild() {
    const childId = document.getElementById('childId').value;
    if (confirm("해당 자녀를 삭제하시겠습니까?")) {
      fetch(`/children/detailPage/delete?childId=${childId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      })
              .then(response => {
                if (!response.ok) {
                  return response.text().then(text => {
                    throw new Error(`Server Error: ${text}`);
                  });
                }
                return response.json(); // JSON 응답이 있을 때 처리
              })
              .then(data => {
                if (data && data.result === 'success') {
                  alert('Child deleted successfully.');
                  // 삭제 후 페이지 이동
                  window.location.href = '/children/page';
                } else {
                  alert('Failed to delete child.');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the child.');
              });
    }
  }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</body>
</html>