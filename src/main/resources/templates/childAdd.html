<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>아이 추가</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/css/sidebar.css" rel="stylesheet">
  <style>
    .interest-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .interest-item {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background-color 0.3s, color 0.3s;
      border: 2px solid #007bff;
      color: #007bff;
      font-weight: bold;
    }

    .interest-item.selected {
      background-color: #007bff;
      color: white;
    }

    #interestSection {
      display: none;
    }

    .profile-picture {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      cursor: pointer;
      overflow: hidden;
    }

    .profile-picture img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-picture img:hover {
      transform: scale(1.1); /* 호버 시 확대 효과 */
    }

    /* 모달 안의 프로필 이미지 스타일 */
    .select-profile-img {
      width: 80px; /* 고정된 너비 */
      height: 80px; /* 고정된 높이 */
      border-radius: 50%; /* 동그랗게 */
      object-fit: cover; /* 이미지 비율 유지하면서 채우기 */
      transition: transform 0.3s ease; /* 선택 시 애니메이션 효과 */
      cursor: pointer;
    }

    .select-profile-img:hover {
      transform: scale(1.1); /* 호버 시 확대 효과 */
    }
  </style>
</head>
<body>
<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar">
  <div class="container-fluid">
    <!-- Toggle Button -->
    <span id="toggleSidebar" class="navbar-toggler-icon"></span>

    <!-- Right-Side Links -->
    <div class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/">메인페이지</a>
        </li>
        <li class="nav-item" th:if="${user == null}">
          <a class="nav-link" href="/login">로그인</a>
        </li>
        <li class="nav-item" th:if="${user == null}">
          <a class="nav-link" href="/signup">회원가입</a>
        </li>
        <li class="nav-item" th:if="${user != null}">
          <a class="nav-link" th:text="${user.name + '님'}"></a>
        </li>
        <li class="nav-item" th:if="${user != null}">
          <a class="nav-link" href="/logout">로그아웃</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Sidebar -->
<div id="sidebar">
  <a href="/children/select">아이 프로필 변경</a>
  <a href="/children/page">아이 정보 수정</a>
  <a href="/userpage">계정보기</a>
  <a href="#">최근 책 보기</a>
  <a href="/templates/BookCategoryHtml.html">좋아요 누른 책 보기</a>
  <a href="#">카테고리 별 책보기</a>
  <a href="/lottery/form">선착순 이벤트</a>
</div>

<!-- 이미지 선택 모달 -->
<div class="modal fade" id="profileImageModal" tabindex="-1" aria-labelledby="profileImageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileImageModalLabel">프로필 이미지 선택</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- 9개의 고정된 프로필 이미지를 보여줍니다. -->
          <div class="col-4 mb-3" th:each="i : ${#numbers.sequence(1,9)}">
            <img src="/assets/img/profile[[${i}]].png"
                 class="img-thumbnail select-profile-img"
                 alt="프로필 이미지 [[${i}]]"
                 data-profile="profile[[${i}]].png"
                 style="cursor: pointer;" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="/assets/js/sidebar.js"></script>


<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <h2 class="text-center mb-4">아이 추가</h2>
      <div class="card">
        <div class="card-body">
          <form id="childForm">
            <div id="basicInfoSection">
              <div class="mb-3 text-center">
                <div class="profile-picture">
                  <img id="profileImage" src="/placeholder.svg?height=100&width=100" alt="프로필 사진">
                </div>
                <p class="mt-2">프로필 사진 선택</p>
              </div>
              <div class="mb-3">
                <label for="name" class="form-label">이름</label>
                <input type="text" class="form-control" id="name" required>
              </div>
              <div class="mb-3">
                <label class="form-label">성별</label>
                <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="male" value="male" required>
                    <label class="form-check-label" for="male">남</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="female" value="female" required>
                    <label class="form-check-label" for="female">여</label>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="age" class="form-label">나이</label>
                <input type="number" class="form-control" id="age" required>
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-primary" onclick="showInterestSection()">다음</button>
              </div>
            </div>

            <div id="interestSection">
              <div class="mb-3">
                <label class="form-label">관심사 선택 (최대 3개)</label>
                <div class="interest-grid">
                  <!-- JavaScript가 이 부분을 채움 -->
                </div>
              </div>
              <div class="text-center">
                <button type="button" class="btn btn-secondary me-2" onclick="showBasicInfoSection()">이전</button>
                <button type="submit" class="btn btn-primary">등록하기</button>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div id="resultMessage" class="mt-3 text-center"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // 카테고리 코드 목록 (서버로부터 전달받은 공통 코드 데이터)
  const categories = [
    { code: "010", name: "소설" },
    { code: "020", name: "전래동화" },
    { code: "030", name: "과학" },
    { code: "040", name: "수학" },
    { code: "050", name: "역사" },
    { code: "060", name: "동물" },
    { code: "070", name: "문학" },
    { code: "080", name: "자연" }
  ];
  // 페이지 로드 시 관심사 목록 렌더링 및 로컬 스토리지에서 저장된 이미지 가져오기
  window.addEventListener('load', function () {
    renderInterests();
    const selectedImage = localStorage.getItem('selectedProfileImage');
    if (selectedImage) {
      document.getElementById('profileImage').src = selectedImage;
    }
  });

  // 모달이 열리면, 9개의 프로필 이미지를 보여주고 클릭 시 이미지 선택
  document.addEventListener('DOMContentLoaded', function() {
    const profileImageModal = new bootstrap.Modal(document.getElementById('profileImageModal'), {});

    // 프로필 사진 선택 버튼을 클릭하면 모달을 연다
    document.querySelector('.profile-picture').addEventListener('click', function() {
      profileImageModal.show();
    });

    // 이미지 선택 시 선택된 이미지 경로를 설정
    document.querySelectorAll('.select-profile-img').forEach(img => {
      img.addEventListener('click', function() {
        const selectedProfile = this.getAttribute('data-profile');
        // 선택된 이미지의 경로를 보여주고 DTO에 설정
        document.getElementById('profileImage').src = `/assets/img/${selectedProfile}`;
        localStorage.setItem('selectedProfileImage', `/assets/img/${selectedProfile}`);
        profileImageModal.hide();
      });
    });

    // 페이지 로드 시 로컬 스토리지에 저장된 이미지가 있다면, 그것을 표시
    const storedImage = localStorage.getItem('selectedProfileImage');
    if (storedImage) {
      document.getElementById('profileImage').src = storedImage;
    }
  });

  // 관심사 목록 동적으로 렌더링
  function renderInterests() {
    const interestGrid = document.querySelector('.interest-grid');
    interestGrid.innerHTML = ''; // 기존 항목 초기화

    categories.forEach(category => {
      const interestItem = document.createElement('div');
      interestItem.className = 'interest-item';
      interestItem.textContent = category.name;
      interestItem.dataset.code = category.code;
      interestItem.onclick = function () {
        toggleInterest(interestItem);
      };
      interestGrid.appendChild(interestItem);
    });
  }

  // 프로필 이미지 동적으로 렌더링
  function renderProfileImages() {
    const modalBody = document.querySelector('.modal-body .row');
    modalBody.innerHTML = ''; // 기존 항목 초기화

    for (let i = 1; i <= 9; i++) {
      const colDiv = document.createElement('div');
      colDiv.className = 'col-4 mb-3';

      const img = document.createElement('img');
      img.src = `/assets/img/profile${i}.png`; // 이미지 경로 설정
      img.className = 'img-thumbnail select-profile-img';
      img.alt = `프로필 이미지 ${i}`;
      img.dataset.profile = `profile${i}.png`;
      img.style.cursor = 'pointer';

      // 이미지 클릭 이벤트 등록
      img.addEventListener('click', function () {
        const selectedProfile = this.dataset.profile;
        document.getElementById('profileImage').src = `/assets/img/${selectedProfile}`;
        localStorage.setItem('selectedProfileImage', `/assets/img/${selectedProfile}`);
        const profileImageModal = bootstrap.Modal.getInstance(document.getElementById('profileImageModal'));
        profileImageModal.hide();
      });

      colDiv.appendChild(img);
      modalBody.appendChild(colDiv);
    }
  }

  // 모달이 열릴 때 프로필 이미지를 렌더링
  document.querySelector('.profile-picture').addEventListener('click', renderProfileImages);

  // 관심사 선택 토글
  function toggleInterest(element) {
    const selectedInterests = document.querySelectorAll('.interest-item.selected');
    if (!element.classList.contains('selected') && selectedInterests.length >= 3) {
      alert('최대 3개까지만 선택할 수 있습니다.');
      return;
    }
    element.classList.toggle('selected');
  }

  // 기본 정보 유효성 검사
  function validateBasicInfo() {
    const name = document.getElementById('name').value;
    const gender = document.querySelector('input[name="gender"]:checked');
    const age = document.getElementById('age').value;

    if (!name || !gender || !age) {
      alert('모든 기본 정보를 입력해주세요.');
      return false;
    }
    return true;
  }

  // 기본 정보 섹션을 숨기고 관심사 섹션을 보여줌
  function showInterestSection() {
    if (validateBasicInfo()) {
      document.getElementById('basicInfoSection').style.display = 'none';
      document.getElementById('interestSection').style.display = 'block';
    }
  }

  // 관심사 섹션을 숨기고 기본 정보 섹션을 보여줌
  function showBasicInfoSection() {
    document.getElementById('basicInfoSection').style.display = 'block';
    document.getElementById('interestSection').style.display = 'none';
  }

  // 폼 데이터 전송
  document.getElementById('childForm').addEventListener('submit', function (e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const gender = document.querySelector('input[name="gender"]:checked').value;
    const age = parseInt(document.getElementById('age').value);
    const interests = Array.from(document.querySelectorAll('.interest-item.selected'))
            .map(el => el.dataset.code);
    const profileImage = document.getElementById('profileImage').src.split('/').pop();

    // ChildAddDto 데이터 구성
    const childAddDto = {
      childDto: {
        childName: name,
        childAge: age,
        childGender: gender.charAt(0).toUpperCase(),
        childImage: profileImage,
        codeMbti: ""
      },
      childFavCategoryDtoList: interests.map(categoryCode => ({
        categoryCode: categoryCode
      }))
    };

    // AJAX 요청
    axios.post('/children/addPage', childAddDto)
            .then(response => {
              document.getElementById('resultMessage').classList.add('text-success');
              localStorage.removeItem('selectedProfileImage');
              window.location.href = "/children/select";
            })
            .catch(error => {
              document.getElementById('resultMessage').textContent = "프로필 등록에 실패했습니다.";
              document.getElementById('resultMessage').classList.add('text-danger');
            });
  });
</script>
</body>
</html>